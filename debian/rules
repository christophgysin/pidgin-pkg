#!/usr/bin/make -f

include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/gnome.mk
include /usr/share/cdbs/1/rules/utils.mk

# Build into a separate directory
DEB_BUILDDIR = $(DEB_SRCDIR)/build
DEB_CONFIGURE_SCRIPT = $(CURDIR)/configure
DEB_CONFIGURE_INVOKE = cd "$(DEB_BUILDDIR)"; $(DEB_CONFIGURE_SCRIPT_ENV) \
	../configure $(DEB_CONFIGURE_NORMAL_ARGS)
LDFLAGS = -Wl,--as-needed

DEB_CONFIGURE_EXTRA_FLAGS := --enable-perl --with-zephyr=/usr --enable-dbus --enable-gnutls=no --enable-nss=yes --enable-cyrus-sasl
DEB_DH_MAKESHLIBS_ARGS_pidgin := -V -X/usr/lib/finch -X/usr/lib/purple-2 -X/usr/lib/pidgin
DEB_DH_SHLIBDEPS_ARGS_pidgin := -X/usr/lib/purple-2/libgg.so -X/usr/lib/purple-2/libzephyr.so -X/usr/lib/purple-2/tcl.so -X/usr/lib/pidgin/gevolution.so -X/usr/lib/purple-2/libsametime.so -- -dSuggests debian/pidgin/usr/lib/purple-2/libgg.so debian/pidgin/usr/lib/purple-2/libzephyr.so debian/pidgin/usr/lib/purple-2/tcl.so debian/pidgin/usr/lib/purple-2/libsametime.so debian/pidgin/usr/lib/purple-2/libsilcpurple.so -dDepends

# documentation is in the pidgin-data package
DEB_DH_LINK_pidgin := usr/share/doc/pidgin-data usr/share/doc/pidgin
DEB_INSTALL_CHANGELOGS_pidgin:= --no-act
DEB_INSTALL_DOCS_pidgin := --no-act

# for pidgin-dev, extra documentation is installed manually below
DEB_DH_LINK_pidgin-dev := usr/share/doc/pidgin-data usr/share/doc/pidgin-dev
DEB_INSTALL_CHANGELOGS_pidgin-dev := --no-act
DEB_INSTALL_DOCS_pidgin-dev := --no-act
DEB_INSTALL_MANPAGES_pidgin-dev := debian/dh_pidgin.1
DEB_DH_STRIP_ARGS_pidgin-dev := -X.html -X.png -X.gif

DEB_DH_LINK_pidgin-dbg := usr/share/doc/pidgin-data usr/share/doc/pidgin-dbg
DEB_INSTALL_CHANGELOGS_pidgin-dbg := --no-act
DEB_INSTALL_DOCS_pidgin-dbg := --no-act

clean::
	rm -f debian/copyright

common-install-impl::
	rm -f debian/tmp/usr/lib/pidgin/relnot.so # release notification plugin
	rm -f debian/tmp/usr/bin/{nullclient,purple-client-example} # examples
	find debian/tmp/usr/lib -name '*.la' -print0 | xargs -0 rm
	# Include author lists in copyright file
	sed -e '/@PIDGIN_COPYRIGHT@/r COPYRIGHT' \
		-e '/@PIDGIN_COPYRIGHT@/d' \
		-e '/@OSCAR_AUTHORS@/r libpurple/protocols/oscar/AUTHORS' \
		-e '/@OSCAR_AUTHORS@/d' \
	debian/copyright.in > debian/copyright

cleanbuilddir/pidgin::
	rm -f doc/TracHeader.html doc/TracFooter.html
	rm -rf $(DEB_SRCDIR)/build

build/pidgin-dev::
	pod2man debian/dh_pidgin > debian/dh_pidgin.1
	touch doc/TracHeader.html doc/TracFooter.html
	cd build; make docs

binary-install/pidgin-dev::
	dh_installdocs -ppidgin-dev debian/README.Debian.dev
	rm -f debian/pidgin-dev/usr/share/doc/pidgin-data/copyright

cleanbuilddir/pidgin-dev::
	rm -f debian/dh_pidgin.1

